#!/bin/bash
set -e

# Override using a local kernel build
if [ -e ${DAPPER_SOURCE}/assets/kernel.tar.gz ]; then
    echo "copying ${DAPPER_SOURCE}/assets/kernel.tar.gz ${DOWNLOADS}/kernel.tar.gz"
    cp ${DAPPER_SOURCE}/assets/kernel.tar.gz ${DOWNLOADS}/kernel.tar.gz
else
    echo "... Downloading  ${!KERNEL_URL}"; \
    if [ -n "${!KERNEL_URL}" ]; then
        curl -fL ${!KERNEL_URL} > ${DOWNLOADS}/kernel.tar.gz
    fi
fi

mkdir -p ${KERNEL_DIR}
tar xf ${DOWNLOADS}/kernel.tar.gz -C ${KERNEL_DIR}

# Use kernel-extra if possible
if [ -e ${DAPPER_SOURCE}/assets/kernel-extra.tar.gz ]; then
    cp ${DAPPER_SOURCE}/assets/kernel-extra.tar.gz ${DOWNLOADS}/kernel-extra.tar.gz
    tar xf ${DOWNLOADS}/kernel-extra.tar.gz -C ${KERNEL_DIR}
fi

if [ -e ${KERNEL_DIR}/boot/vmlinuz-* ]; then
    echo "Copy ${KERNEL_DIR}/boot/vmlinuz-* to ${ARTIFACTS}/vmlinuz-${KERNEL_VERSION}"
    cp ${KERNEL_DIR}/boot/vmlinuz-* ${ARTIFACTS}/vmlinuz-${KERNEL_VERSION}
    cp ${KERNEL_DIR}/boot/vmlinuz-* ${KERNEL_DIR}/vmlinuz
fi

if [ -d ${KERNEL_DIR}/lib ]; then
    #cp -rf ${BUILD}/kernel/lib ${INITRD_DIR}/usr/
    depmod -b ${KERNEL_DIR} $(basename ${KERNEL_DIR}/lib/modules/*)
fi
