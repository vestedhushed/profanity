#!/bin/bash
set -e
set -x

source $(dirname $0)/version
cd $(dirname $0)/..

ISO=${ARTIFACTS}/k3os.iso

DIST=$(pwd)/dist

mkdir -p ${DIST}/boot/isolinux/
cat scripts/syslinux/isolinux.cfg | envsubst > ${DIST}/boot/isolinux/isolinux.cfg
cat scripts/syslinux/isolinux_label.cfg | LABEL=${VERSION} envsubst > ${DIST}/boot/linux-current.cfg
cat scripts/syslinux/global.cfg | envsubst > ${DIST}/boot/global.cfg
cp scripts/syslinux/rancher.png ${DIST}/boot/

CD=${BUILD}/cd
rm -rf ${CD}/
mkdir -p ${CD}/boot

cp ${ARTIFACTS}/${INITRD}                      ${CD}/boot/
cp ${ARTIFACTS}/vmlinuz-${KERNEL_VERSION}      ${CD}/boot/

cp -r ${DIST}/boot/*                           ${CD}/boot/
cp /usr/lib/ISOLINUX/isolinux.bin              ${CD}/boot/isolinux/
cp /usr/lib/syslinux/modules/bios/ldlinux.c32  ${CD}/boot/isolinux/
cp /usr/lib/syslinux/modules/bios/*.c32        ${CD}/boot/isolinux/

pushd ${CD}
xorriso -as mkisofs \
    -l -J -R -V "K3OS" \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
    -b boot/isolinux/isolinux.bin -c boot/isolinux/boot.cat \
    -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
    -o $ISO .
popd
