#!/bin/sh

BOOT_DEVICE=$(blkid -L RANCHER_BOOT)
if [ ! -z "${BOOT_DEVICE}" ]; then
    mount ${BOOT_DEVICE} /boot
fi

STATE_DEVICE=$(blkid -L RANCHER_STATE)
if [ -z "${STATE_DEVICE}" ]; then
    echo "No LABEL=RANCHER_STATE device, so we use tmpfs"

    ## for ssh
    mkdir -p /tmp/system-data/etc/ssh
    cp -arf /etc/ssh/* /tmp/system-data/etc/ssh
    mount -t tmpfs tmpfs /etc/ssh
    cp -arf /tmp/system-data/etc/ssh/* /etc/ssh

    ## for dhcpcd
    mount -t tmpfs tmpfs /var/db/dhcpcd

    # clean tmp dir
    rm -rf /tmp/system-data
    exit 0
fi

# hard code for test
mount ${STATE_DEVICE} /writable
mkdir /writable/system-data /writable/user-data /writable/tmp

## for ssh
mkdir -p /writable/system-data/etc/ssh
cp -arf /etc/ssh /writable/tmp
mount -o bind /writable/system-data/etc/ssh /etc/ssh
cp -arf /writable/tmp/ssh/* /etc/ssh

## for dhcpcd
mkdir -p /writable/system-data/vardb/dhcpcd
mount -o bind /writable/system-data/vardb/dhcpcd /var/db/dhcpcd

# clean tmp dir
rm -rf /writable/tmp
